@page "/microerp"
@using Rayonnant.Module.MicroErp.Services
@inject CustomerService CustomerService
@inject OrderService OrderService  
@inject GuidebookService GuidebookService

<MudText Typo="Typo.h4" Class="mb-4">MicroERP - Pulpit Główny</MudText>

<MudGrid>
    <MudItem xs="12" md="3">
        <MudPaper Class="pa-4" Elevation="3">
            <div class="d-flex align-center mb-2">
                <MudIcon Icon="@Icons.Material.Filled.People" Color="Color.Primary" Size="Size.Large" Class="mr-2" />
                <div>
                    <MudText Typo="Typo.h6">@_customersCount</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Tertiary">Klientów</MudText>
                </div>
            </div>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="3">
        <MudPaper Class="pa-4" Elevation="3">
            <div class="d-flex align-center mb-2">
                <MudIcon Icon="@Icons.Material.Filled.Assignment" Color="Color.Success" Size="Size.Large" Class="mr-2" />
                <div>
                    <MudText Typo="Typo.h6">@_activeOrdersCount</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Tertiary">Aktywne zamówienia</MudText>
                </div>
            </div>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="3">
        <MudPaper Class="pa-4" Elevation="3">
            <div class="d-flex align-center mb-2">
                <MudIcon Icon="@Icons.Material.Filled.BuildCircle" Color="Color.Warning" Size="Size.Large" Class="mr-2" />
                <div>
                    <MudText Typo="Typo.h6">@_activeGuidebooksCount</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Tertiary">Aktywne karty pracy</MudText>
                </div>
            </div>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="3">
        <MudPaper Class="pa-4" Elevation="3">
            <div class="d-flex align-center mb-2">
                <MudIcon Icon="@Icons.Material.Filled.Memory" Color="Color.Info" Size="Size.Large" Class="mr-2" />
                <div>
                    <MudText Typo="Typo.h6">@_totalOrders</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Tertiary">Wszystkich zamówień</MudText>
                </div>
            </div>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="8">
        <MudPaper Class="pa-4" Elevation="3">
            <MudText Typo="Typo.h6" Class="mb-3">Ostatnie zamówienia</MudText>
            @if (_recentOrders?.Any() == true)
            {
                <MudTable Items="_recentOrders" Dense="true" Hover="true" Elevation="0">
                    <HeaderContent>
                        <MudTh>Klient</MudTh>
                        <MudTh>PCB</MudTh>
                        <MudTh>Ilość</MudTh>
                        <MudTh>Termin</MudTh>
                        <MudTh>Status</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.CustomerName</MudTd>
                        <MudTd>@context.Pcb?.Name</MudTd>
                        <MudTd>@context.OrderedQty szt.</MudTd>
                        <MudTd>@context.OrderExpirationDate.ToString("dd.MM.yyyy")</MudTd>
                        <MudTd>
                            <MudChip T="string" Size="Size.Small" Color="@GetOrderStatusColor(context)">
                                @GetOrderStatusText(context)
                            </MudChip>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
            else
            {
                <MudText Color="Color.Tertiary">Brak zamówień</MudText>
            }
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="4">
        <MudPaper Class="pa-4" Elevation="3">
            <MudText Typo="Typo.h6" Class="mb-3">Szybkie akcje</MudText>
            <MudStack Spacing="2">
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          StartIcon="@Icons.Material.Filled.Add"
                          FullWidth="true"
                          Href="/microerp/orders">
                    Nowe zamówienie
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Secondary" 
                          StartIcon="@Icons.Material.Filled.Person"
                          FullWidth="true"
                          Href="/microerp/customers">
                    Zarządzaj klientami
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Info" 
                          StartIcon="@Icons.Material.Filled.Memory"
                          FullWidth="true"
                          Href="/microerp/pcbs">
                    Zarządzaj PCB
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Warning" 
                          StartIcon="@Icons.Material.Filled.Assignment"
                          FullWidth="true"
                          Href="/microerp/guidebooks">
                    Karty pracy
                </MudButton>
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private int _customersCount;
    private int _activeOrdersCount;
    private int _activeGuidebooksCount;
    private int _totalOrders;
    private List<Order> _recentOrders = new();

    protected override async Task OnInitializedAsync()
    {
        var customers = await CustomerService.GetAllAsync();
        _customersCount = customers.Count;

        var allOrders = await OrderService.GetAllAsync();
        _totalOrders = allOrders.Count;
        
        var activeOrders = await OrderService.GetActiveOrdersAsync();
        _activeOrdersCount = activeOrders.Count;

        var activeGuidebooks = await GuidebookService.GetActiveGuidebooksAsync();
        _activeGuidebooksCount = activeGuidebooks.Count;

        _recentOrders = allOrders.Take(5).ToList();
    }

    private Color GetOrderStatusColor(Order order)
    {
        if (order.OrderFinished) return Color.Success;
        if (order.OrderExpirationDate < DateTime.Today) return Color.Error;
        if (order.OrderExpirationDate < DateTime.Today.AddDays(7)) return Color.Warning;
        return Color.Info;
    }

    private string GetOrderStatusText(Order order)
    {
        if (order.OrderFinished) return "Zakończone";
        if (order.OrderExpirationDate < DateTime.Today) return "Opóźnione";
        if (order.OrderExpirationDate < DateTime.Today.AddDays(7)) return "Pilne";
        return "W realizacji";
    }
}