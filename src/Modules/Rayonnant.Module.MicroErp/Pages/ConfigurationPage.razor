@page "/microerp/config"
@using Rayonnant.Module.MicroErp.Services
@inject ConfigurationService ConfigurationService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudText Typo="Typo.h4" Class="mb-4">Konfiguracja</MudText>

<MudPaper Class="pa-4" Elevation="2">
    <MudTabs Elevation="4" Rounded="true" PanelClass="pa-6">
        <MudTabPanel Text="Kolory Soldera">
            <ConfigurationTable T="SolderColor" 
                              Items="_solderColors" 
                              Title="Kolory Soldera"
                              OnCreate="CreateSolderColor"
                              OnEdit="EditSolderColor"
                              OnDelete="DeleteSolderColor" />
        </MudTabPanel>
        
        <MudTabPanel Text="Kolory Opisów">
            <ConfigurationTable T="OverlayColor" 
                              Items="_overlayColors" 
                              Title="Kolory Opisów"
                              OnCreate="CreateOverlayColor"
                              OnEdit="EditOverlayColor"
                              OnDelete="DeleteOverlayColor" />
        </MudTabPanel>
        
        <MudTabPanel Text="Materiały">
            <ConfigurationTable T="Material" 
                              Items="_materials" 
                              Title="Materiały"
                              OnCreate="CreateMaterial"
                              OnEdit="EditMaterial"
                              OnDelete="DeleteMaterial"
                              ShowMaterialDetails="true" />
        </MudTabPanel>
        
        <MudTabPanel Text="Pokrywy">
            <ConfigurationTable T="CoverType" 
                              Items="_coverTypes" 
                              Title="Rodzaje pokryw"
                              OnCreate="CreateCoverType"
                              OnEdit="EditCoverType"
                              OnDelete="DeleteCoverType" />
        </MudTabPanel>
        
        <MudTabPanel Text="Typy montażu">
            <ConfigurationTable T="AssemblyType" 
                              Items="_assemblyTypes" 
                              Title="Typy montażu"
                              OnCreate="CreateAssemblyType"
                              OnEdit="EditAssemblyType"
                              OnDelete="DeleteAssemblyType" />
        </MudTabPanel>
        
        <MudTabPanel Text="Technologie montażu">
            <ConfigurationTable T="AssemblyTechnologyType" 
                              Items="_assemblyTechnologyTypes" 
                              Title="Technologie montażu"
                              OnCreate="CreateAssemblyTechnologyType"
                              OnEdit="EditAssemblyTechnologyType"
                              OnDelete="DeleteAssemblyTechnologyType" />
        </MudTabPanel>
        
        <MudTabPanel Text="Typy zamówień">
            <ConfigurationTable T="OrderType" 
                              Items="_orderTypes" 
                              Title="Typy zamówień"
                              OnCreate="CreateOrderType"
                              OnEdit="EditOrderType"
                              OnDelete="DeleteOrderType" />
        </MudTabPanel>
        
        <MudTabPanel Text="Typy dostaw">
            <ConfigurationTable T="OrderDeliveryType" 
                              Items="_orderDeliveryTypes" 
                              Title="Typy dostaw"
                              OnCreate="CreateOrderDeliveryType"
                              OnEdit="EditOrderDeliveryType"
                              OnDelete="DeleteOrderDeliveryType" />
        </MudTabPanel>
        
        <MudTabPanel Text="Dokumentacja">
            <ConfigurationTable T="DocumentationType" 
                              Items="_documentationTypes" 
                              Title="Typy dokumentacji"
                              OnCreate="CreateDocumentationType"
                              OnEdit="EditDocumentationType"
                              OnDelete="DeleteDocumentationType" />
        </MudTabPanel>
    </MudTabs>
</MudPaper>

@code {
    private List<SolderColor> _solderColors = new();
    private List<OverlayColor> _overlayColors = new();
    private List<Material> _materials = new();
    private List<CoverType> _coverTypes = new();
    private List<AssemblyType> _assemblyTypes = new();
    private List<AssemblyTechnologyType> _assemblyTechnologyTypes = new();
    private List<OrderType> _orderTypes = new();
    private List<OrderDeliveryType> _orderDeliveryTypes = new();
    private List<DocumentationType> _documentationTypes = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadAllData();
    }

    private async Task LoadAllData()
    {
        _solderColors = await ConfigurationService.GetSolderColorsAsync();
        _overlayColors = await ConfigurationService.GetOverlayColorsAsync();
        _materials = await ConfigurationService.GetMaterialsAsync();
        _coverTypes = await ConfigurationService.GetCoverTypesAsync();
        _assemblyTypes = await ConfigurationService.GetAssemblyTypesAsync();
        _assemblyTechnologyTypes = await ConfigurationService.GetAssemblyTechnologyTypesAsync();
        _orderTypes = await ConfigurationService.GetOrderTypesAsync();
        _orderDeliveryTypes = await ConfigurationService.GetOrderDeliveryTypesAsync();
        _documentationTypes = await ConfigurationService.GetDocumentationTypesAsync();
    }

    // Solder Colors
    private async Task CreateSolderColor() => await EditSolderColor(new SolderColor());
    private async Task EditSolderColor(SolderColor solderColor)
    {
        var parameters = new DialogParameters<SimpleEditDialog>
        {
            ["Title"] = solderColor.Id == 0 ? "Nowy kolor soldera" : "Edytuj kolor soldera",
            ["Value"] = solderColor.Name
        };

        var dialog = await DialogService.ShowAsync<SimpleEditDialog>("", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string name && !string.IsNullOrWhiteSpace(name))
        {
            solderColor.Name = name;
            await ConfigurationService.SaveSolderColorAsync(solderColor);
            _solderColors = await ConfigurationService.GetSolderColorsAsync();
            Snackbar.Add("Kolor soldera zapisany", Severity.Success);
        }
    }
    
    private async Task DeleteSolderColor(SolderColor solderColor)
    {
        if (await ConfirmDelete($"kolor soldera '{solderColor.Name}'"))
        {
            await ConfigurationService.DeleteSolderColorAsync(solderColor.Id);
            _solderColors = await ConfigurationService.GetSolderColorsAsync();
            Snackbar.Add("Kolor soldera usunięty", Severity.Info);
        }
    }

    // Overlay Colors
    private async Task CreateOverlayColor() => await EditOverlayColor(new OverlayColor());
    private async Task EditOverlayColor(OverlayColor overlayColor)
    {
        var parameters = new DialogParameters<SimpleEditDialog>
        {
            ["Title"] = overlayColor.Id == 0 ? "Nowy kolor opisu" : "Edytuj kolor opisu",
            ["Value"] = overlayColor.Name
        };

        var dialog = await DialogService.ShowAsync<SimpleEditDialog>("", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string name && !string.IsNullOrWhiteSpace(name))
        {
            overlayColor.Name = name;
            await ConfigurationService.SaveOverlayColorAsync(overlayColor);
            _overlayColors = await ConfigurationService.GetOverlayColorsAsync();
            Snackbar.Add("Kolor opisu zapisany", Severity.Success);
        }
    }
    
    private async Task DeleteOverlayColor(OverlayColor overlayColor)
    {
        if (await ConfirmDelete($"kolor opisu '{overlayColor.Name}'"))
        {
            await ConfigurationService.DeleteOverlayColorAsync(overlayColor.Id);
            _overlayColors = await ConfigurationService.GetOverlayColorsAsync();
            Snackbar.Add("Kolor opisu usunięty", Severity.Info);
        }
    }

    // Materials (simplified - just name editing for now)
    private async Task CreateMaterial() => await EditMaterial(new Material());
    private async Task EditMaterial(Material material)
    {
        var parameters = new DialogParameters<SimpleEditDialog>
        {
            ["Title"] = material.Id == 0 ? "Nowy materiał" : "Edytuj materiał",
            ["Value"] = material.Name
        };

        var dialog = await DialogService.ShowAsync<SimpleEditDialog>("", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string name && !string.IsNullOrWhiteSpace(name))
        {
            material.Name = name;
            if (material.Id == 0)
            {
                material.CopperThicknessInUm = "35";
                material.MaterialThicknessInMm = 1.6;
                material.TwoSided = true;
            }
            await ConfigurationService.SaveMaterialAsync(material);
            _materials = await ConfigurationService.GetMaterialsAsync();
            Snackbar.Add("Materiał zapisany", Severity.Success);
        }
    }
    
    private async Task DeleteMaterial(Material material)
    {
        if (await ConfirmDelete($"materiał '{material.Name}'"))
        {
            await ConfigurationService.DeleteMaterialAsync(material.Id);
            _materials = await ConfigurationService.GetMaterialsAsync();
            Snackbar.Add("Materiał usunięty", Severity.Info);
        }
    }

    // Similar methods for other types (shortened for brevity)
    private async Task CreateCoverType() => await EditCoverType(new CoverType());
    private async Task EditCoverType(CoverType item) => await EditGenericItem(item, "pokrywa", ConfigurationService.SaveCoverTypeAsync, () => ConfigurationService.GetCoverTypesAsync().ContinueWith(t => _coverTypes = t.Result));
    private async Task DeleteCoverType(CoverType item) => await DeleteGenericItem(item, "pokrywa", ConfigurationService.DeleteCoverTypeAsync, () => ConfigurationService.GetCoverTypesAsync().ContinueWith(t => _coverTypes = t.Result));

    private async Task CreateAssemblyType() => await EditAssemblyType(new AssemblyType());
    private async Task EditAssemblyType(AssemblyType item) => await EditGenericItem(item, "typ montażu", ConfigurationService.SaveAssemblyTypeAsync, () => ConfigurationService.GetAssemblyTypesAsync().ContinueWith(t => _assemblyTypes = t.Result));
    private async Task DeleteAssemblyType(AssemblyType item) => await DeleteGenericItem(item, "typ montażu", ConfigurationService.DeleteAssemblyTypeAsync, () => ConfigurationService.GetAssemblyTypesAsync().ContinueWith(t => _assemblyTypes = t.Result));

    private async Task CreateAssemblyTechnologyType() => await EditAssemblyTechnologyType(new AssemblyTechnologyType());
    private async Task EditAssemblyTechnologyType(AssemblyTechnologyType item) => await EditGenericItem(item, "technologia montażu", ConfigurationService.SaveAssemblyTechnologyTypeAsync, () => ConfigurationService.GetAssemblyTechnologyTypesAsync().ContinueWith(t => _assemblyTechnologyTypes = t.Result));
    private async Task DeleteAssemblyTechnologyType(AssemblyTechnologyType item) => await DeleteGenericItem(item, "technologia montażu", ConfigurationService.DeleteAssemblyTechnologyTypeAsync, () => ConfigurationService.GetAssemblyTechnologyTypesAsync().ContinueWith(t => _assemblyTechnologyTypes = t.Result));

    private async Task CreateOrderType() => await EditOrderType(new OrderType());
    private async Task EditOrderType(OrderType item) => await EditGenericItem(item, "typ zamówienia", ConfigurationService.SaveOrderTypeAsync, () => ConfigurationService.GetOrderTypesAsync().ContinueWith(t => _orderTypes = t.Result));
    private async Task DeleteOrderType(OrderType item) => await DeleteGenericItem(item, "typ zamówienia", ConfigurationService.DeleteOrderTypeAsync, () => ConfigurationService.GetOrderTypesAsync().ContinueWith(t => _orderTypes = t.Result));

    private async Task CreateOrderDeliveryType() => await EditOrderDeliveryType(new OrderDeliveryType());
    private async Task EditOrderDeliveryType(OrderDeliveryType item) => await EditGenericItem(item, "typ dostawy", ConfigurationService.SaveOrderDeliveryTypeAsync, () => ConfigurationService.GetOrderDeliveryTypesAsync().ContinueWith(t => _orderDeliveryTypes = t.Result));
    private async Task DeleteOrderDeliveryType(OrderDeliveryType item) => await DeleteGenericItem(item, "typ dostawy", ConfigurationService.DeleteOrderDeliveryTypeAsync, () => ConfigurationService.GetOrderDeliveryTypesAsync().ContinueWith(t => _orderDeliveryTypes = t.Result));

    private async Task CreateDocumentationType() => await EditDocumentationType(new DocumentationType());
    private async Task EditDocumentationType(DocumentationType item) => await EditGenericItem(item, "typ dokumentacji", ConfigurationService.SaveDocumentationTypeAsync, () => ConfigurationService.GetDocumentationTypesAsync().ContinueWith(t => _documentationTypes = t.Result));
    private async Task DeleteDocumentationType(DocumentationType item) => await DeleteGenericItem(item, "typ dokumentacji", ConfigurationService.DeleteDocumentationTypeAsync, () => ConfigurationService.GetDocumentationTypesAsync().ContinueWith(t => _documentationTypes = t.Result));

    // Generic helper methods
    private async Task EditGenericItem<T>(T item, string typeName, Func<T, Task<T>> saveFunc, Func<Task> refreshFunc) where T : class
    {
        var nameProperty = typeof(T).GetProperty("Name");
        var idProperty = typeof(T).GetProperty("Id");
        
        var currentName = nameProperty?.GetValue(item)?.ToString() ?? "";
        var isNew = (int)(idProperty?.GetValue(item) ?? 0) == 0;

        var parameters = new DialogParameters<SimpleEditDialog>
        {
            ["Title"] = isNew ? $"Nowy {typeName}" : $"Edytuj {typeName}",
            ["Value"] = currentName
        };

        var dialog = await DialogService.ShowAsync<SimpleEditDialog>("", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string name && !string.IsNullOrWhiteSpace(name))
        {
            nameProperty?.SetValue(item, name);
            await saveFunc(item);
            await refreshFunc();
            Snackbar.Add($"{char.ToUpper(typeName[0])}{typeName.Substring(1)} zapisany", Severity.Success);
        }
    }

    private async Task DeleteGenericItem<T>(T item, string typeName, Func<int, Task> deleteFunc, Func<Task> refreshFunc) where T : class
    {
        var nameProperty = typeof(T).GetProperty("Name");
        var idProperty = typeof(T).GetProperty("Id");
        
        var name = nameProperty?.GetValue(item)?.ToString() ?? "";
        var id = (int)(idProperty?.GetValue(item) ?? 0);

        if (await ConfirmDelete($"{typeName} '{name}'"))
        {
            await deleteFunc(id);
            await refreshFunc();
            Snackbar.Add($"{char.ToUpper(typeName[0])}{typeName.Substring(1)} usunięty", Severity.Info);
        }
    }

    private async Task<bool> ConfirmDelete(string itemName)
    {
        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Czy na pewno chcesz usunąć {itemName}?",
            ["ButtonText"] = "Usuń",
            ["Color"] = Color.Error
        };

        var dialog = await DialogService.ShowAsync<MudMessageBox>("Potwierdź usunięcie", parameters);
        var result = await dialog.Result;

        return !result.Canceled && bool.TryParse(result.Data?.ToString(), out bool confirmed) && confirmed;
    }
}

// Placeholder components - would be implemented as separate components
@code { 
    public class ConfigurationTable<T> : ComponentBase where T : class
    {
        [Parameter] public List<T> Items { get; set; } = new();
        [Parameter] public string Title { get; set; } = string.Empty;
        [Parameter] public EventCallback OnCreate { get; set; }
        [Parameter] public EventCallback<T> OnEdit { get; set; }
        [Parameter] public EventCallback<T> OnDelete { get; set; }
        [Parameter] public bool ShowMaterialDetails { get; set; }
    }
    
    public class SimpleEditDialog : MudDialog 
    { 
        [Parameter] public string Title { get; set; } = string.Empty;
        [Parameter] public string Value { get; set; } = string.Empty;
    }
}