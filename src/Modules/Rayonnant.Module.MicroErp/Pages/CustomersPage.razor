@page "/microerp/customers"
@using Rayonnant.Module.MicroErp.Services
@inject CustomerService CustomerService
@inject ConfigurationService ConfigurationService
@inject IDialogService DialogService

<MudText Typo="Typo.h4" Class="mb-4">Klienci</MudText>

<MudPaper Class="pa-4" Elevation="2">
    <div class="d-flex align-center mb-4">
        <MudText Typo="Typo.h6">Lista klientów</MudText>
        <MudSpacer />
        <MudTextField T="string" 
                     @bind-Value="_searchString" 
                     @oninput="OnSearchChanged"
                     Placeholder="Szukaj klientów..." 
                     Variant="Variant.Outlined"
                     Margin="Margin.Dense" 
                     Adornment="Adornment.Start"
                     AdornmentIcon="@Icons.Material.Filled.Search" 
                     Class="mr-2" 
                     Style="max-width:300px;" />
        <MudButton Variant="Variant.Filled" 
                  Color="Color.Primary" 
                  StartIcon="@Icons.Material.Filled.PersonAdd"
                  OnClick="OpenCreateCustomerDialog">
            Nowy klient
        </MudButton>
    </div>

    <MudDataGrid T="Customer" Items="_customers" 
                 Dense="true" 
                 Hover="true" 
                 Elevation="0"
                 Loading="_loading"
                 Virtualize="true"
                 FixedHeader="true"
                 Height="600px">
        <Columns>
            <PropertyColumn Property="x => x.Id" Title="ID" />
            <PropertyColumn Property="x => x.Name" Title="Nazwa firmy" />
            <PropertyColumn Property="x => x.Person" Title="Osoba kontaktowa" />
            <PropertyColumn Property="x => x.City" Title="Miasto" />
            <PropertyColumn Property="x => x.PhoneNumber" Title="Telefon" />
            <TemplateColumn Title="Dostawa">
                <CellTemplate>
                    @if (context.Item!.DefaultDeliveryType != null)
                    {
                        <MudChip Size="Size.Small" Color="Color.Info">@context.Item.DefaultDeliveryType.Name</MudChip>
                    }
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Akcje">
                <CellTemplate>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                  Size="Size.Small" 
                                  OnClick="() => EditCustomer(context.Item!)" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                  Size="Size.Small" 
                                  Color="Color.Error"
                                  OnClick="() => DeleteCustomer(context.Item!)" />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="Customer" />
        </PagerContent>
    </MudDataGrid>
</MudPaper>

@code {
    private List<Customer> _customers = new();
    private string _searchString = string.Empty;
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadCustomers();
    }

    private async Task LoadCustomers()
    {
        _loading = true;
        _customers = string.IsNullOrWhiteSpace(_searchString) 
            ? await CustomerService.GetAllAsync() 
            : await CustomerService.SearchAsync(_searchString);
        _loading = false;
    }

    private async Task OnSearchChanged(ChangeEventArgs e)
    {
        _searchString = e.Value?.ToString() ?? string.Empty;
        await LoadCustomers();
    }

    private async Task OpenCreateCustomerDialog()
    {
        var parameters = new DialogParameters<CustomerEditDialog>
        {
            ["IsCreateMode"] = true
        };

        var dialog = await DialogService.ShowAsync<CustomerEditDialog>("Nowy klient", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadCustomers();
        }
    }

    private async Task EditCustomer(Customer customer)
    {
        var parameters = new DialogParameters<CustomerEditDialog>
        {
            ["Customer"] = customer,
            ["IsCreateMode"] = false
        };

        var dialog = await DialogService.ShowAsync<CustomerEditDialog>($"Edytuj klienta: {customer.Name}", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadCustomers();
        }
    }

    private async Task DeleteCustomer(Customer customer)
    {
        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Czy na pewno chcesz usunąć klienta {customer.Name}?",
            ["ButtonText"] = "Usuń",
            ["Color"] = Color.Error
        };

        var dialog = await DialogService.ShowAsync<MudMessageBox>("Potwierdź usunięcie", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && bool.TryParse(result.Data?.ToString(), out bool confirmed) && confirmed)
        {
            await CustomerService.DeleteAsync(customer.Id);
            await LoadCustomers();
        }
    }
}

// Placeholder for CustomerEditDialog - would be implemented as a separate component
@code { 
    public class CustomerEditDialog : MudDialog { }
}