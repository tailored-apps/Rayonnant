@page "/microerp/orders"
@using Rayonnant.Module.MicroErp.Services
@inject OrderService OrderService
@inject PcbService PcbService
@inject ConfigurationService ConfigurationService
@inject IDialogService DialogService

<MudText Typo="Typo.h4" Class="mb-4">Zamówienia</MudText>

<MudPaper Class="pa-4" Elevation="2">
    <div class="d-flex align-center mb-4">
        <MudText Typo="Typo.h6">Lista zamówień</MudText>
        <MudSpacer />
        <MudTextField T="string" 
                     @bind-Value="_searchString" 
                     @oninput="OnSearchChanged"
                     Placeholder="Szukaj zamówień..." 
                     Variant="Variant.Outlined"
                     Margin="Margin.Dense" 
                     Adornment="Adornment.Start"
                     AdornmentIcon="@Icons.Material.Filled.Search" 
                     Class="mr-2" 
                     Style="max-width:300px;" />
        <MudButton Variant="Variant.Filled" 
                  Color="Color.Primary" 
                  StartIcon="@Icons.Material.Filled.Add"
                  OnClick="OpenCreateOrderDialog">
            Nowe zamówienie
        </MudButton>
    </div>

    <MudDataGrid T="Order" Items="_orders" 
                 Dense="true" 
                 Hover="true" 
                 Elevation="0"
                 Loading="_loading"
                 Virtualize="true"
                 FixedHeader="true"
                 Height="600px">
        <Columns>
            <PropertyColumn Property="x => x.Id" Title="ID" />
            <PropertyColumn Property="x => x.CustomerName" Title="Klient" />
            <PropertyColumn Property="x => x.Pcb!.Name" Title="PCB" />
            <PropertyColumn Property="x => x.OrderedQty" Title="Ilość" />
            <PropertyColumn Property="x => x.OrderDate" Title="Data zamówienia" Format="dd.MM.yyyy" />
            <PropertyColumn Property="x => x.OrderExpirationDate" Title="Termin" Format="dd.MM.yyyy" />
            <TemplateColumn Title="Status">
                <CellTemplate>
                    <MudChip Size="Size.Small" Color="@GetOrderStatusColor(context.Item!)">
                        @GetOrderStatusText(context.Item!)
                    </MudChip>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Solder Mask">
                <CellTemplate>
                    <div class="d-flex">
                        @if (context.Item!.SolderLayerTop != null)
                        {
                            <MudChip Size="Size.Small" Color="Color.Success" Class="mr-1">T: @context.Item.SolderLayerTop.Name</MudChip>
                        }
                        @if (context.Item.SolderLayerBottom != null)
                        {
                            <MudChip Size="Size.Small" Color="Color.Info">B: @context.Item.SolderLayerBottom.Name</MudChip>
                        }
                    </div>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Opcje">
                <CellTemplate>
                    <div class="d-flex">
                        @if (context.Item!.Smt)
                        {
                            <MudChip Size="Size.Small" Color="Color.Primary" Class="mr-1">SMT</MudChip>
                        }
                        @if (context.Item.Tht)
                        {
                            <MudChip Size="Size.Small" Color="Color.Secondary" Class="mr-1">THT</MudChip>
                        }
                        @if (context.Item.HolePlatting)
                        {
                            <MudChip Size="Size.Small" Color="Color.Tertiary" Class="mr-1">HP</MudChip>
                        }
                        @if (context.Item.Express)
                        {
                            <MudChip Size="Size.Small" Color="Color.Error">⚡ Express</MudChip>
                        }
                    </div>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Akcje">
                <CellTemplate>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                  Size="Size.Small" 
                                  OnClick="() => EditOrder(context.Item!)" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                  Size="Size.Small" 
                                  Color="Color.Error"
                                  OnClick="() => DeleteOrder(context.Item!)" />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="Order" />
        </PagerContent>
    </MudDataGrid>
</MudPaper>

@code {
    private List<Order> _orders = new();
    private string _searchString = string.Empty;
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        _loading = true;
        _orders = string.IsNullOrWhiteSpace(_searchString) 
            ? await OrderService.GetAllAsync() 
            : await OrderService.SearchAsync(_searchString);
        _loading = false;
    }

    private async Task OnSearchChanged(ChangeEventArgs e)
    {
        _searchString = e.Value?.ToString() ?? string.Empty;
        await LoadOrders();
    }

    private async Task OpenCreateOrderDialog()
    {
        var parameters = new DialogParameters<OrderEditDialog>
        {
            ["IsCreateMode"] = true
        };

        var dialog = await DialogService.ShowAsync<OrderEditDialog>("Nowe zamówienie", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadOrders();
        }
    }

    private async Task EditOrder(Order order)
    {
        var parameters = new DialogParameters<OrderEditDialog>
        {
            ["Order"] = order,
            ["IsCreateMode"] = false
        };

        var dialog = await DialogService.ShowAsync<OrderEditDialog>($"Edytuj zamówienie #{order.Id}", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadOrders();
        }
    }

    private async Task DeleteOrder(Order order)
    {
        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Czy na pewno chcesz usunąć zamówienie #{order.Id} dla {order.CustomerName}?",
            ["ButtonText"] = "Usuń",
            ["Color"] = Color.Error
        };

        var dialog = await DialogService.ShowAsync<MudMessageBox>("Potwierdź usunięcie", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && bool.TryParse(result.Data?.ToString(), out bool confirmed) && confirmed)
        {
            await OrderService.DeleteAsync(order.Id);
            await LoadOrders();
        }
    }

    private Color GetOrderStatusColor(Order order)
    {
        if (order.OrderFinished) return Color.Success;
        if (order.OrderExpirationDate < DateTime.Today) return Color.Error;
        if (order.OrderExpirationDate < DateTime.Today.AddDays(7)) return Color.Warning;
        return Color.Info;
    }

    private string GetOrderStatusText(Order order)
    {
        if (order.OrderFinished) return "Zakończone";
        if (order.OrderExpirationDate < DateTime.Today) return "Opóźnione";
        if (order.OrderExpirationDate < DateTime.Today.AddDays(7)) return "Pilne";
        return "W realizacji";
    }
}

// Placeholder for OrderEditDialog - would be implemented as a separate component
@code { 
    public class OrderEditDialog : MudDialog { }
}